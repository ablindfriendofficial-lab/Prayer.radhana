<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Strict Project Viewer | Firebase Edition</title>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

    :root {
      --bg-main: #0f172a;
      --bg-panel: #1e293b;
      --border: #334155;
      --text-main: #f1f5f9;
      --text-dim: #94a3b8;
      --accent: #f59e0b;
      --accent-hover: #d97706;
      --success: #22c55e;
      --error: #ef4444;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-main);
      color: var(--text-main);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .view-section { display: none; width:100%; height:100%; flex-direction:column; position:absolute; top:0; left:0; background:var(--bg-main); }
    .view-section.active { display:flex; z-index:10; }
    .center-screen { justify-content: center; align-items: center; }

    .action-box { width:90%; max-width:480px; padding:2rem; background:var(--bg-panel); border:1px solid var(--border); border-radius:16px; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.3); }
    
    .btn-base { padding:12px 20px; border-radius:8px; border:none; cursor:pointer; font-weight:600; transition:0.2s; display:inline-flex; align-items:center; justify-content:center; gap:8px; font-size:0.95rem; }
    .btn-primary { background:var(--accent); color:black; }
    .btn-primary:hover { background:var(--accent-hover); }
    .btn-secondary { background:var(--border); color:white; }
    .btn-secondary:hover { background:#475569; }
    .btn-danger { background:var(--error); color:white; }
    .btn-success { background:var(--success); color:white; }
    .btn-text { background:none; border:none; color:var(--text-dim); text-decoration:underline; cursor:pointer; font-size:0.85rem; margin-top:10px; }

    input, textarea { width:100%; padding:12px; margin:10px 0; border-radius:8px; background:var(--bg-main); border:1px solid var(--border); color:white; outline:none; transition: border-color 0.2s; }
    input:focus, textarea:focus { border-color: var(--accent); }
    
    .code-area { 
        width: 100%; height: 100%; background: #0f172a; color: #f8fafc; 
        font-family: monospace; padding: 20px; border: none; resize: none; 
        font-size: 14px; line-height: 1.5; outline: none;
    }

    .toolbar { height:64px; background:var(--bg-panel); border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; padding:0 1.5rem; flex-shrink:0; }
    .toolbar-group { display:flex; gap:10px; align-items:center; }

    .scroll-container { flex:1; overflow-y:auto; padding:1rem; }
    .projects-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:1.5rem; max-width:1200px; margin:0 auto; }
    .project-card { background:var(--bg-panel); border:1px solid var(--border); border-radius:12px; padding:1.5rem; display:flex; flex-direction:column; gap:1rem; transition:0.2s; position: relative;}
    .project-card:hover { transform:translateY(-4px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }

    .editor-workspace { flex:1; display:flex; flex-direction:column; overflow:hidden; }
    .editor-tabs { display:flex; background:#1e293b; border-bottom:1px solid var(--border); }
    .tab-btn { padding:12px 25px; background:none; border:none; color:var(--text-dim); cursor:pointer; border-bottom:2px solid transparent; font-weight:600; }
    .tab-btn.active { color:var(--accent); border-bottom-color:var(--accent); background:rgba(255,255,255,0.05); }
    
    .editor-pane { flex:1; display:flex; flex-direction:column; width: 100%; }
    iframe { width:100%; height:100%; border:none; display: block; background: white; }

    .spinner { width:40px; height:40px; border:4px solid rgba(255,255,255,0.1); border-top-color:var(--accent); border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 20px; }
    @keyframes spin { to { transform:rotate(360deg); } }

    .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.8); display:none; align-items:center; justify-content:center; z-index:1000; backdrop-filter:blur(4px); }
    .exit-fullscreen { position:fixed; top:15px; right:15px; z-index:100; background:rgba(0,0,0,0.6); color:white; border:1px solid white; padding:8px 16px; border-radius:6px; cursor:pointer; }
    .error-msg { color:var(--error); font-size:0.85rem; margin:10px 0; display:none; background:rgba(239,68,68,0.1); padding:10px; border-radius:6px; text-align: left; }
  </style>
</head>
<body>

  <!-- LOADING VIEW -->
  <div id="view-loading" class="view-section active center-screen">
    <div style="text-align:center;">
      <div class="spinner"></div>
      <h3>Connecting...</h3>
      <p id="loading-status" style="color:var(--text-dim); margin-top:10px;">Checking Database Status...</p>
    </div>
  </div>

  <!-- AUTH VIEW -->
  <div id="view-auth" class="view-section center-screen">
    <div class="action-box">
      <h2 id="form-title">Login</h2>
      <p style="color:var(--text-dim); margin-bottom:1rem; font-size:0.9rem;">Project HTML Database</p>
      
      <input type="email" id="auth-email" placeholder="Email Address">
      <input type="password" id="auth-password" placeholder="Password">
      <input type="password" id="auth-confirm" placeholder="Confirm Password" style="display:none;">
      
      <div id="auth-error" class="error-msg"></div>
      
      <div style="display:flex; flex-direction:column; gap:10px; width:100%; margin-top: 10px;">
        <button class="btn-base btn-primary" id="login-btn">Log In</button>
        <button class="btn-base btn-secondary" id="signup-btn" style="display:none;">Sign Up</button>
      </div>
      <button class="btn-text" id="toggle-auth-mode">Need an account? Sign Up</button>
    </div>
  </div>

  <!-- DASHBOARD VIEW -->
  <div id="view-upload" class="view-section">
    <header class="toolbar">
      <span style="font-weight:600; font-size: 0.8rem; color: var(--accent);" id="user-display">Connecting...</span>
      <div class="toolbar-group">
        <button class="btn-base btn-secondary" id="my-projects-btn">üóÉÔ∏è My Projects</button>
        <button class="btn-base btn-danger" id="logout-btn">Log Out</button>
      </div>
    </header>
    <div class="center-screen" style="flex:1;">
      <div class="action-box" id="drop-zone">
        <h2>Upload Project</h2>
        <p style="font-size:0.8rem; color:var(--text-dim); margin-bottom:15px;">Local storage se files select karein</p>
        <div style="display:flex; gap:10px; justify-content:center; margin:20px 0;">
          <label class="btn-base btn-primary" style="cursor:pointer;">+ Select Files<input type="file" id="file-input" multiple hidden></label>
        </div>
        <div id="file-list-preview" style="text-align:left; font-size:0.8rem; margin:10px 0;"></div>
        <div id="upload-actions" style="display:none; flex-direction:column; gap:10px;">
          <button class="btn-base btn-success" id="save-cloud-btn">üíæ Save to Cloud</button>
          <button class="btn-base btn-primary" id="local-preview-btn">üìù Open Editor</button>
        </div>
      </div>
    </div>
  </div>

  <!-- PROJECTS LIST VIEW -->
  <div id="view-projects" class="view-section">
    <header class="toolbar">
      <button class="btn-base btn-secondary" id="back-upload">‚Üê Back</button>
      <span class="toolbar-title">My Projects</span>
      <div style="width:50px;"></div>
    </header>
    <div class="scroll-container">
      <div id="projects-list-grid" class="projects-grid"></div>
    </div>
  </div>

  <!-- EDITOR VIEW -->
  <div id="view-workspace" class="view-section">
    <header class="toolbar">
      <button class="btn-base btn-secondary" id="back-projects-from-edit">‚Üê Back</button>
      <div class="toolbar-group">
        <button class="btn-base btn-primary" id="run-code-btn">‚ñ∂ Run</button>
        <button class="btn-base btn-success" id="save-changes-btn">üíæ Save</button>
      </div>
    </header>
    <div class="editor-workspace">
        <div class="editor-tabs">
          <button class="tab-btn active" data-tab="html">index.html</button>
          <button class="tab-btn" data-tab="css">style.css</button>
          <button class="tab-btn" data-tab="js">script.js</button>
        </div>
        <div class="editor-pane">
            <textarea id="edit-html" class="code-area" spellcheck="false"></textarea>
            <textarea id="edit-css" class="code-area" style="display:none;" spellcheck="false"></textarea>
            <textarea id="edit-js" class="code-area" style="display:none;" spellcheck="false"></textarea>
        </div>
    </div>
  </div>

  <!-- PREVIEW VIEW -->
  <div id="view-fullscreen" class="view-section">
    <button class="exit-fullscreen" id="exit-full">‚úï Close Preview</button>
    <iframe id="fullscreen-frame"></iframe>
  </div>

  <!-- SAVE MODAL -->
  <div id="modal-save" class="modal-overlay">
    <div class="action-box">
      <h3>Project Name</h3>
      <input type="text" id="project-name-input" placeholder="e.g. My Portfolio">
      <button class="btn-base btn-success" id="modal-save-confirm" style="width:100%;">Save Now</button>
      <button class="btn-text" id="modal-cancel">Cancel</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, signInAnonymously, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
    import { getFirestore, collection, doc, getDocs, addDoc, updateDoc, deleteDoc, serverTimestamp, query, onSnapshot } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'project-html-database';
    const firebaseConfig = {
      apiKey: "AIzaSyCF4sjV8ee5rsiGTRkmyEOvbylzKPBu9Xc",
      authDomain: "project-html-3634c.firebaseapp.com",
      projectId: "project-html-3634c",
      storageBucket: "project-html-3634c.appspot.com",
      messagingSenderId: "106742296896", 
      appId: "1:106742296896:web:314a77f5143fd0afdb4aa5"
    };

    let auth, db, currentUser, projectsList = [], uploadedFilesMap = new Map(), currentProjectId = null;

    const get = id => document.getElementById(id);
    const switchView = id => document.querySelectorAll('.view-section').forEach(v => v.classList.toggle('active', v.id === id));

    async function init() {
      try {
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);

        onAuthStateChanged(auth, user => {
          if (user) {
            currentUser = user;
            // Agar email nahi hai toh UID dikhayenge
            get('user-display').innerText = user.email ? user.email : "ID: " + user.uid.substring(0, 8) + "...";
            setupRealtimeListener();
            switchView('view-upload');
          } else {
            switchView('view-auth');
          }
        });

        // Gemini environment automatic login logic
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
        } else {
            // Testing ke liye agar Token nahi hai toh Anonymous login
            await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("Auth Error:", err);
      }
    }

    function setupRealtimeListener() {
        if (!currentUser) return;
        const q = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'projects');
        onSnapshot(q, (snap) => {
            projectsList = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderProjects();
        }, (err) => console.error(err));
    }

    function renderProjects() {
        const grid = get('projects-list-grid');
        grid.innerHTML = projectsList.length ? '' : '<p style="color:var(--text-dim); padding:20px;">No projects found.</p>';
        projectsList.forEach(p => {
          const div = document.createElement('div');
          div.className = 'project-card';
          div.innerHTML = `<h3>${p.name}</h3><div style="display:flex;gap:10px;"><button class="btn-base btn-primary btn-run" style="flex:1">Run</button><button class="btn-base btn-secondary btn-edit" style="flex:1">Edit</button><button class="btn-base btn-danger btn-del">üóë</button></div>`;
          div.querySelector('.btn-run').onclick = () => {
            get('fullscreen-frame').srcdoc = `<html><head><style>${p.css}</style></head><body>${p.html}<script>${p.js}<\/script></body></html>`;
            switchView('view-fullscreen');
          };
          div.querySelector('.btn-edit').onclick = () => {
            currentProjectId = p.id;
            get('edit-html').value = p.html; get('edit-css').value = p.css; get('edit-js').value = p.js;
            switchView('view-workspace');
          };
          div.querySelector('.btn-del').onclick = async () => {
            if(confirm("Delete this project?")) await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'projects', p.id));
          };
          grid.appendChild(div);
        });
    }

    get('login-btn').onclick = () => signInWithEmailAndPassword(auth, get('auth-email').value, get('auth-password').value).catch(e => alert(e.message));
    get('signup-btn').onclick = () => createUserWithEmailAndPassword(auth, get('auth-email').value, get('auth-password').value).catch(e => alert(e.message));
    get('logout-btn').onclick = () => signOut(auth);

    get('toggle-auth-mode').onclick = () => {
        const isL = get('login-btn').style.display !== 'none';
        get('login-btn').style.display = isL ? 'none' : 'flex';
        get('signup-btn').style.display = isL ? 'flex' : 'none';
        get('auth-confirm').style.display = isL ? 'block' : 'none';
        get('form-title').innerText = isL ? 'Sign Up' : 'Login';
        get('toggle-auth-mode').innerText = isL ? 'Already have an account? Login' : 'Need an account? Sign Up';
    };

    get('file-input').onchange = async e => {
        for (let f of e.target.files) {
            const txt = await f.text();
            const lower = f.name.toLowerCase();
            if (lower.endsWith('.html')) uploadedFilesMap.set('html', txt);
            if (lower.endsWith('.css')) uploadedFilesMap.set('css', txt);
            if (lower.endsWith('.js')) uploadedFilesMap.set('js', txt);
        }
        get('upload-actions').style.display = uploadedFilesMap.size > 0 ? 'flex' : 'none';
        get('file-list-preview').innerHTML = Array.from(uploadedFilesMap.keys()).map(k => `‚úì ${k.toUpperCase()} load ho gayi`).join('<br>');
    };

    get('save-cloud-btn').onclick = () => get('modal-save').style.display = 'flex';
    get('modal-save-confirm').onclick = async () => {
        const name = get('project-name-input').value;
        if(!name) return;
        get('modal-save-confirm').disabled = true;
        try {
            await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'projects'), {
                name: name,
                html: uploadedFilesMap.get('html') || '', 
                css: uploadedFilesMap.get('css') || '', 
                js: uploadedFilesMap.get('js') || '',
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp()
            });
            get('modal-save').style.display = 'none';
            get('project-name-input').value = "";
            switchView('view-projects');
        } catch(e) { alert(e.message); }
        get('modal-save-confirm').disabled = false;
    };

    get('save-changes-btn').onclick = async () => {
        if(!currentProjectId) return;
        try {
            await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'projects', currentProjectId), {
                html: get('edit-html').value, css: get('edit-css').value, js: get('edit-js').value, updatedAt: serverTimestamp()
            });
            alert("Updated!");
        } catch(e) { alert(e.message); }
    };

    get('run-code-btn').onclick = () => {
        get('fullscreen-frame').srcdoc = `<html><head><style>${get('edit-css').value}</style></head><body>${get('edit-html').value}<script>${get('edit-js').value}<\/script></body></html>`;
        switchView('view-fullscreen');
    };

    get('my-projects-btn').onclick = () => switchView('view-projects');
    get('back-upload').onclick = () => switchView('view-upload');
    get('back-projects-from-edit').onclick = () => switchView('view-projects');
    get('exit-full').onclick = () => switchView('view-workspace');
    get('modal-cancel').onclick = () => get('modal-save').style.display = 'none';
    get('local-preview-btn').onclick = () => {
        get('edit-html').value = uploadedFilesMap.get('html') || '';
        get('edit-css').value = uploadedFilesMap.get('css') || '';
        get('edit-js').value = uploadedFilesMap.get('js') || '';
        switchView('view-workspace');
    };

    document.querySelectorAll('.tab-btn').forEach(b => b.onclick = () => {
        document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('active'));
        b.classList.add('active');
        ['html', 'css', 'js'].forEach(t => get('edit-' + t).style.display = t === b.dataset.tab ? 'block' : 'none');
    });

    init();
  </script>
</body>
</html>

